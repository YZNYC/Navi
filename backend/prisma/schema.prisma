generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//
enum Papel {
  ADMINISTRADOR
  PROPRIETARIO
  MOTORISTA
  FUNCIONARIO
}

enum TipoVaga {
  PADRAO
  PCD
  IDOSO
  ELETRICO
  MOTO
}

enum StatusVaga {
  LIVRE
  OCUPADA
  RESERVADA
  MANUTENCAO
}

enum TipoDesconto {
  PERCENTUAL
  FIXO
}

enum MetodoPagamento {
  PIX
  DEBITO
  CREDITO
  DINHEIRO
}

enum StatusPagamento {
  PENDENTE
  APROVADO
  RECUSADO
  ESTORNADO
}

enum StatusContrato {
  ATIVO
  INATIVO
  CANCELADO
}

enum StatusReserva {
  ATIVA
  CONCLUIDA
  CANCELADA
  EXPIRADA
}

enum TipoAnexo {
  IMAGEM
  VIDEO
}

//
// USUÁRIO
//
model usuario {
  id_usuario        Int       @id @default(autoincrement())
  nome              String
  email             String    @unique
  senha             String
  telefone          String?
  url_foto_perfil   String?
  papel             Papel
  data_criacao      DateTime  @default(now())
  ativo             Boolean   @default(true)
  resetToken        String?
  resetTokenExpires DateTime?

  // Relações
  veiculos            veiculo[]
  reservas            reserva[]
  avaliacoes          avaliacao[]
  chatparticipante    ChatParticipante[]
  mensagens           Mensagem[]                   @relation("MensagemRemetente")
  leituras            LeituraMensagem[]
  estacionamentos     estacionamento[]             @relation("Proprietario")
  funcionario_est     estacionamento_funcionario[]
  contratoMensalistas contrato_mensalista[]

  @@map("usuario")
}

//
// ESTACIONAMENTO
//
model estacionamento {
  id_estacionamento  Int       @id @default(autoincrement())
  id_proprietario    Int
  nome               String
  cnpj               String    @unique
  cep                String
  rua                String
  numero             String
  bairro             String
  cidade             String
  estado             String
  endereco_completo  String
  latitude           Decimal
  longitude          Decimal
  url_foto_principal String?
  horario_abertura   DateTime?
  horario_fechamento DateTime?
  dias_funcionamento String?
  ativo              Boolean   @default(true)
  data_criacao       DateTime  @default(now())

  proprietario usuario @relation(fields: [id_proprietario], references: [id_usuario], name: "Proprietario")

  vagas        vaga[]
  precos       politica_preco[]
  planos       plano_mensal[]
  funcionarios estacionamento_funcionario[]
  avaliacoes   avaliacao[]

  @@unique([cep, numero])
  @@unique([latitude, longitude])
  @@map("estacionamento")
}

//
// FUNCIONÁRIO DE ESTACIONAMENTO
//
model estacionamento_funcionario {
  id_estacionamento Int
  id_usuario        Int
  permissao         String
  data_admissao     DateTime @default(now())

  estacionamento estacionamento @relation(fields: [id_estacionamento], references: [id_estacionamento])
  usuario        usuario        @relation(fields: [id_usuario], references: [id_usuario])

  @@id([id_estacionamento, id_usuario])
  @@map("estacionamento_funcionario")
}

//
// VEÍCULO
//
model veiculo {
  id_veiculo     Int      @id @default(autoincrement())
  id_usuario     Int
  placa          String   @unique
  marca          String
  modelo         String
  cor            String
  url_foto_placa String?
  apelido        String?
  ativo          Boolean  @default(true)
  data_criacao   DateTime @default(now())

  usuario   usuario               @relation(fields: [id_usuario], references: [id_usuario])
  contratos contrato_mensalista[]
  reservas  reserva[]

  @@map("veiculo")
}

//
// VAGA
//
model vaga {
  id_vaga           Int        @id @default(autoincrement())
  id_estacionamento Int
  identificador     String
  tipo_vaga         TipoVaga   @default(PADRAO)
  status            StatusVaga @default(LIVRE)

  estacionamento estacionamento @relation(fields: [id_estacionamento], references: [id_estacionamento])
  reservas       reserva[]      @relation("VagaReservas")

  @@unique([id_estacionamento, identificador])
  @@map("vaga")
}

//
// POLÍTICA DE PREÇO
//
model politica_preco {
  id_politica_preco      Int     @id @default(autoincrement())
  id_estacionamento      Int
  descricao              String
  preco_primeira_hora    Decimal @default(0.00)
  preco_horas_adicionais Decimal @default(0.00)
  preco_diaria           Decimal @default(0.00)
  ativo                  Boolean @default(true)

  estacionamento estacionamento @relation(fields: [id_estacionamento], references: [id_estacionamento])

  @@unique([id_estacionamento, descricao])
  @@map("politica_preco")
}

//
// PLANO MENSAL
//
model plano_mensal {
  id_plano          Int     @id @default(autoincrement())
  id_estacionamento Int
  nome_plano        String
  descricao         String?
  preco_mensal      Decimal
  ativo             Boolean @default(true)

  estacionamento estacionamento        @relation(fields: [id_estacionamento], references: [id_estacionamento])
  contratos      contrato_mensalista[]

  @@unique([id_estacionamento, nome_plano])
  @@map("plano_mensal")
}

//
// CONTRATO MENSALISTA
//
model contrato_mensalista {
  id_contrato Int            @id @default(autoincrement())
  id_usuario  Int
  id_plano    Int
  id_veiculo  Int
  data_inicio DateTime
  data_fim    DateTime?
  status      StatusContrato

  usuario usuario      @relation(fields: [id_usuario], references: [id_usuario])
  plano   plano_mensal @relation(fields: [id_plano], references: [id_plano])
  veiculo veiculo      @relation(fields: [id_veiculo], references: [id_veiculo])

  @@map("contrato_mensalista")
}

//
// RESERVA
//
model reserva {
  id_reserva         Int           @id @default(autoincrement())
  id_usuario         Int
  id_vaga            Int
  id_veiculo         Int?
  codigo_confirmacao String?
  data_hora_inicio   DateTime      @default(now())
  data_hora_fim      DateTime?
  status             StatusReserva

  usuario   usuario    @relation(fields: [id_usuario], references: [id_usuario])
  vaga      vaga       @relation("VagaReservas", fields: [id_vaga], references: [id_vaga])
  veiculo   veiculo?   @relation(fields: [id_veiculo], references: [id_veiculo])
  pagamento pagamento?

  @@map("reserva")
}

//
// PAGAMENTO
//
model pagamento {
  id_pagamento   Int             @id @default(autoincrement())
  id_reserva     Int             @unique
  id_cupom       Int?
  valor_bruto    Decimal
  valor_desconto Decimal         @default(0.00)
  valor_liquido  Decimal
  metodo         MetodoPagamento
  status         StatusPagamento
  url_recibo     String?
  data_hora      DateTime        @default(now())

  reserva reserva @relation(fields: [id_reserva], references: [id_reserva])
  cupom   cupom?  @relation(fields: [id_cupom], references: [id_cupom])

  @@map("pagamento")
}

//
// CUPOM
//
model cupom {
  id_cupom      Int          @id @default(autoincrement())
  codigo        String       @unique
  descricao     String?
  tipo_desconto TipoDesconto
  valor         Decimal
  data_validade DateTime
  usos_maximos  Int          @default(1)
  usos_atuais   Int          @default(0)
  ativo         Boolean      @default(true)

  pagamentos pagamento[]

  @@map("cupom")
}

//
// AVALIAÇÃO
//
model avaliacao {
  id_avaliacao      Int      @id @default(autoincrement())
  id_usuario        Int
  id_estacionamento Int
  nota              Decimal
  comentario        String?
  data_postagem     DateTime @default(now())

  usuario        usuario           @relation(fields: [id_usuario], references: [id_usuario])
  estacionamento estacionamento    @relation(fields: [id_estacionamento], references: [id_estacionamento])
  anexos         anexo_avaliacao[]

  @@map("avaliacao")
}

model anexo_avaliacao {
  id_anexo     Int       @id @default(autoincrement())
  id_avaliacao Int
  tipo_anexo   TipoAnexo
  url_anexo    String

  avaliacao avaliacao @relation(fields: [id_avaliacao], references: [id_avaliacao])

  @@map("anexo_avaliacao")
}

//
// CHAT (COM ANEXOS)
//
model Chat {
  id           Int      @id @default(autoincrement())
  nome         String?
  data_criacao DateTime @default(now())

  participantes ChatParticipante[]
  mensagens     Mensagem[]
}

model ChatParticipante {
  id            Int      @id @default(autoincrement())
  id_chat       Int
  id_usuario    Int
  ultimo_acesso DateTime @default(now())

  chat    Chat    @relation(fields: [id_chat], references: [id])
  usuario usuario @relation(fields: [id_usuario], references: [id_usuario])

  @@unique([id_chat, id_usuario])
}

model Mensagem {
  id           Int      @id @default(autoincrement())
  id_chat      Int
  id_remetente Int
  conteudo     String?
  data_envio   DateTime @default(now())

  chat      Chat    @relation(fields: [id_chat], references: [id])
  remetente usuario @relation("MensagemRemetente", fields: [id_remetente], references: [id_usuario])

  anexos   MensagemAnexo[]
  leituras LeituraMensagem[]
}

model MensagemAnexo {
  id           Int    @id @default(autoincrement())
  id_mensagem  Int
  url          String
  tipo         String
  nome_arquivo String

  mensagem Mensagem @relation(fields: [id_mensagem], references: [id])
}

model LeituraMensagem {
  id           Int      @id @default(autoincrement())
  id_mensagem  Int
  id_leitor    Int
  data_leitura DateTime @default(now())

  mensagem Mensagem @relation(fields: [id_mensagem], references: [id])
  leitor   usuario  @relation(fields: [id_leitor], references: [id_usuario])

  @@unique([id_mensagem, id_leitor])
}
